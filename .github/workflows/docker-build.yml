name: Build Docker Image

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Docker
        uses: docker/setup-buildx-action@v2

      - name: Get version number
        id: version
        run: |
          if [ ! -f .version ]; then
            echo "1" > .version
          fi
          VERSION=$(cat .version)
          echo "version_number=$VERSION" >> $GITHUB_ENV

      - name: Increment version number
        id: increment_version
        run: |
          VERSION=$(cat .version)
          NEXT_VERSION=$((VERSION + 1))
          echo $NEXT_VERSION > .version
          echo "next_version=$NEXT_VERSION" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build -t my-docker-image:$version_number -t my-docker-image:latest -f big_data/Dockerfile .

      - name: Push Docker image to registry
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
          docker push my-docker-image:$version_number
          docker push my-docker-image:latest

      - name: Commit updated version file
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .version
          git commit -m "Update version to $next_version"
          git push
